<launch>
  <arg name="max_range" default="0"/>
  <arg name="p2n" default="true"/>
  <arg name="pm" default="true"/>
  
  <param name="/use_sim_time" value="true"/>
  
  <node pkg="tf" type="static_transform_publisher"  name="base_to_realsense"
      args="0 0 0 0 0 0 /base_link /kinect 100" />

  <node pkg="tf" type="static_transform_publisher" name="world_to_map" 
      args="0 0 0 0 0 0 /world /map 100" />

  <node pkg="rtabmap_ros" type="icp_odometry" name="icp_odometry" output="screen" >
     <remap from="scan"      to="/scan"/>
     <remap from="odom"      to="/scanmatch_odom"/>
     <remap from="odom_info" to="/rtabmap/odom_info"/>
	  
     <param name="frame_id"        type="string" value="base_link"/>
          
     <param name="Icp/VoxelSize"     type="string" value="0.05"/>
     <param name="Icp/RangeMax"      type="string" value="$(arg max_range)"/>
     <param name="Icp/Epsilon"       type="string" value="0.001"/>
     
     <param if="$(arg p2n)" name="Icp/PointToPlane"  type="string" value="false"/>
     <param if="$(arg p2n)" name="Icp/PointToPlaneK"  type="string" value="5"/>
     <param if="$(arg p2n)" name="Icp/PointToPlaneRadius"  type="string" value="0.3"/>
     <param unless="$(arg p2n)" name="Icp/PointToPlane"  type="string" value="false"/>
     <param unless="$(arg p2n)" name="Icp/PointToPlaneK"  type="string" value="0"/>
     <param unless="$(arg p2n)" name="Icp/PointToPlaneRadius"  type="string" value="0"/>
          
     <param name="Icp/MaxCorrespondenceDistance" type="string" value="0.2"/>
     <param name="Icp/PM"             type="string" value="$(arg pm)"/> <!-- use libpointmatcher to handle PointToPlane with 2d scans-->
     <param name="Icp/PMOutlierRatio" type="string" value="0.85"/>
     <param name="Odom/Strategy"        type="string" value="0"/>
     <param name="Odom/GuessMotion"     type="string" value="true"/>
     <param name="Odom/ResetCountdown"  type="string" value="0"/>
     <param name="Odom/ScanKeyFrameThr"  type="string" value="0.9"/>
  </node>

  <group ns="rtabmap">
      <node pkg="nodelet" type="nodelet" name="rgbd_sync" args="standalone rtabmap_ros/rgbd_sync" output="screen">
      <remap from="depth/image"         to="/camera/depth/image"/>
      <remap from="rgb/image"           to="/camera/rgb/image_color"/>
      <remap from="rgb/camera_info"     to="/camera/rgb/camera_info"/>
            
      <remap from="rgbd_image"          to="rgbd_image"/>
            
      <param name="approx_sync"       value="true"/> 
      </node>

      <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" args="--delete_db_on_start">
          <param name="frame_id" type="string" value="base_link"/>          
          
          <param name="subscribe_odom" type="bool" value="true"/>
          <param name="subscribe_odom_info" type="bool" value="true"/>
          
          <param name="subscribe_depth" type="bool" value="false"/>
          <param name="subscribe_rgbd" type="bool" value="true"/>
          <param name="subscribe_scan" type="bool" value="true"/>
          
          <remap from="scan"        to="/scan"/>
          <remap from="rgbd_image"  to="/rtabmap/rgbd_image"/>
          <remap from="odom"        to="/scanmatch_odom"/>
          <remap from="odom_info"   to="/rtabmap/odom_info"/>

          <param name="queue_size" type="int" value="10"/>

          <!-- RTAB-Map's parameters -->
          <param name="RGBD/NeighborLinkRefining" type="string" value="true"/>
          <param name="RGBD/ProximityBySpace"     type="string" value="true"/>
          <param name="RGBD/AngularUpdate"        type="string" value="0.01"/>
          <param name="RGBD/LinearUpdate"         type="string" value="0.01"/>
          <param name="RGBD/OptimizeFromGraphEnd" type="string" value="false"/>
          <param name="Grid/FromDepth"            type="string" value="true"/> <!-- occupancy grid from camera -->
          <param name="Reg/Force3DoF"             type="string" value="true"/>
          <param name="Reg/Strategy"              type="string" value="2"/> <!-- 1=ICP -->
          
          <!-- ICP parameters -->
          <param name="Icp/VoxelSize"                 type="string" value="0.05"/>
          <param name="Icp/MaxCorrespondenceDistance" type="string" value="0.1"/>
      </node>

    <!-- Visualisation RTAB-Map 
    <node pkg="rtabmap_ros" type="rtabmapviz" name="rtabmapviz" args="-d $(find rtabmap_ros)/launch/config/rgbd_gui.ini" output="screen">
      <param name="subscribe_rgbd"      type="bool" value="true"/>
      <param name="subscribe_laserScan" type="bool" value="true"/>
      <param name="frame_id"            type="string" value="base_footprint"/>
    
      <remap from="scan"            to="scan"/>

      <remap from="odom" to="/scanmatch_odom"/>
      <param name="subscribe_odom_info" type="bool" value="true"/>
    </node>
    -->
  </group>

  
</launch>